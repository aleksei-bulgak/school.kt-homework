/*
 * This Kotlin source file was generated by the Gradle 'init' task.
 */
package by.bulgak.playground

class Query {
    var columns: List<String> = listOf("*")
    var from: String = ""
    var orderBy: String = ""
    var limit: Int = 0

    fun isValid(): Boolean {
        if(columns.isEmpty() || columns.filter { it.isBlank() }.isNotEmpty()) {
            throw Exception("List of columns for return can not be empty or has blank lines")
            //println("List of columns for return can not be empty or has blank lines")
            //return false
        }
        if(from.isBlank()) {
            throw Exception("From element can not be nul or empty")
            //println("From element can not be null or empty")
            //return false
        }
        if(orderBy.isNotBlank() && columns.filter { it.equals(orderBy) }.isEmpty()) {
            throw Exception("Specified value for ordering $orderBy is not resented in result columns $columns")
            //println("Specified value for ordering $orderBy is not resented in result columns $columns")
            //return false
        }
        if(limit < 0) {
            throw Exception("Limit $limit should be positive integer value")
        }
        return true
    }

    fun build(): String {
        var query = columns.joinToString(prefix = "SELECT ") { it }
                .plus(" FROM ").plus(from)
        if (orderBy.isNotBlank()) query += " ORDER BY ".plus(orderBy)
        if (limit > 0) query += " LIMIT ".plus(limit)
        return query
    }
}

fun query(request: Query.() -> Unit): String? {
    val query = Query().apply(request)
    return if(query.isValid()) query.build() else ""
}